{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-12 col-lg-7 col-xl-7 col-xxl-7">
            <h1 class="text-uppercase">ĐƠN HÀNG</h1>
            <p>Không hợp đồng. Dùng thử 30 ngày. Bộ thiết bị Starlink sẽ đến trong vòng 5–6 ngày.</p>
            
            <!-- Country Selection -->
            <div class="d-flex justify-content-center align-items-center mb-4">
                <div class="dropdown w-100">
                    <button id="list_tinh" class="btn dropdown-toggle w-100 text-white fw-bold" type="button">
                        CHỌN QUỐC GIA
                    </button>
                    <div id="list-nd-tinh" class="dropdown-menu">
                        <!-- Country list will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Product Image -->
            <img src="{% static 'img/starlink_mini_order_product_feature.webp' %}" class="img-fluid mb-4" alt="Starlink Kit">

            <!-- Kit Selection -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="fw-bold">Starlink Kit</h5>
                    <select id="kit_select" class="form-select mb-3" onchange="updateTotal()">
                        {% for product in products %}
                            {% if product.msp|slice:":3" == "KIT" %}
                                <option value="{{ product.gia }}" data-msp="{{ product.msp }}">
                                    {{ product.tensp }} - {{ product.gia|floatformat:0 }}đ
                                </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Mounts and Accessories Section -->
            <div style="padding: 2%;background-color: #0c0c0c;">
                <h2 style="padding-left: 2%;">Đế và Phụ kiện</h2>
                <div class="d-flex justify-content-around align-items-center flex-row flex-wrap">
                    <div class="text-center">
                        <img src="{% static 'img/starlink_mini_roof_rack_mount_500x500.webp' %}" style="max-height: 190px;" alt="Đế gắn trên nóc xe">
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="roof_mount" value="4000000" onchange="updateTotal()">
                            <label class="form-check-label" for="roof_mount">
                                Đế gắn trên nóc xe<br>4Tr
                            </label>
                        </div>
                    </div>
                    <div class="text-center">
                        <img src="{% static 'img/starlink_mini_mobility_mount_500x500.webp' %}" style="max-height: 190px;" alt="Đế di động">
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="mobility_mount" value="3000000" onchange="updateTotal()">
                            <label class="form-check-label" for="mobility_mount">
                                Đế di động<br>3Tr
                            </label>
                        </div>
                    </div>
                    <div class="text-center">
                        <img src="{% static 'img/500x500-Router_Mini_WiFi.webp' %}" style="max-height: 190px;" alt="Bộ định tuyến Mini">
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="router_mini" value="10000000" onchange="updateTotal()">
                            <label class="form-check-label" for="router_mini">
                                Bộ định tuyến Mini<br>10Tr
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Summary Column -->
        <div class="col-md-12 col-lg-5 col-xl-5 col-xxl-5">
            <div class="card">
                <div class="card-body">
                    <h4 class="fw-bold mb-4">Thanh toán hàng tháng định kỳ</h4>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold">{{ selected_product.tensp }}</h5>
                        <h5 class="fw-bold">{{ selected_product.gia|floatformat:0 }}đ/Tháng</h5>
                    </div>
                    <p class="mb-4">{{ selected_product.mota }}</p>

                    <h4 class="fw-bold mb-4">Thanh toán một lần</h4>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold">Starlink Kit</h5>
                        <h5 class="fw-bold" id="kit_price">0đ</h5>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold">Phụ kiện đã chọn</h5>
                        <h5 class="fw-bold" id="accessories_price">0đ</h5>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold">Vận chuyển & Xử lý</h5>
                        <h5 class="fw-bold">0đ</h5>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="fw-bold">Tổng tiền:</h4>
                        <h4 class="fw-bold" id="total_price">0đ</h4>
                    </div>

                    <!-- Customer Information Form -->
                    <div class="mb-4">
                        <h4 class="fw-bold mb-3">Thông tin khách hàng</h4>
                        <div class="mb-3">
                            <label for="customer_name" class="form-label">Họ và tên</label>
                            <input type="text" class="form-control" id="customer_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="customer_phone" class="form-label">Số điện thoại</label>
                            <input type="tel" class="form-control" id="customer_phone" required>
                        </div>
                        <div class="mb-3">
                            <label for="customer_notes" class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="customer_notes" rows="3"></textarea>
                        </div>
                    </div>

                    <button id="paymentButton" class="btn btn-light w-100 fw-bold py-3" type="button" disabled>
                        Thanh toán
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const fbMessengerLink = `https://m.me/your_page_id?ref=${encodeURIComponent(message)}`;

function formatPrice(price) {
    return new Intl.NumberFormat('vi-VN').format(price) + 'đ';
}

function updateTotal() {
    // Get kit price
    const kitPrice = parseInt(document.getElementById('kit_select').value) || 0;
    document.getElementById('kit_price').textContent = formatPrice(kitPrice);
    
    // Get accessories total
    let accessoriesTotal = 0;
    document.querySelectorAll('.form-check-input:checked').forEach(checkbox => {
        accessoriesTotal += parseInt(checkbox.value) || 0;
    });
    document.getElementById('accessories_price').textContent = formatPrice(accessoriesTotal);
    
    // Calculate and display total
    const total = kitPrice + accessoriesTotal;
    document.getElementById('total_price').textContent = formatPrice(total);
}

// Validate form and enable/disable payment button
function validateForm() {
    const name = document.getElementById('customer_name').value.trim();
    const phone = document.getElementById('customer_phone').value.trim();
    const paymentButton = document.getElementById('paymentButton');
    
    if (name && phone) {
        paymentButton.disabled = false;
    } else {
        paymentButton.disabled = true;
    }
}

// Send order to Facebook Messenger
function sendToMessenger() {
    const name = document.getElementById('customer_name').value.trim();
    const phone = document.getElementById('customer_phone').value.trim();
    const notes = document.getElementById('customer_notes').value.trim();
    const total = document.getElementById('total_price').textContent;
    const selectedKit = document.getElementById('kit_select').options[document.getElementById('kit_select').selectedIndex].text;
    
    // Get selected accessories
    let accessories = [];
    document.querySelectorAll('.form-check-input:checked').forEach(checkbox => {
        accessories.push(checkbox.parentElement.textContent.trim());
    });

    // Prepare order data
    const orderData = {
        customer_name: name,
        phone: phone,
        product: selectedKit,
        accessories: accessories.join(', ') || 'Không có',
        total: total,
        notes: notes || 'Không có'
    };

    // Send to server
    fetch('/process-order/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(orderData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Đơn hàng đã được gửi thành công!');
        } else {
            alert('Có lỗi xảy ra khi gửi đơn hàng. Vui lòng thử lại sau.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Có lỗi xảy ra khi gửi đơn hàng. Vui lòng thử lại sau.');
    });
}

// Get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Add event listeners
document.addEventListener('DOMContentLoaded', function() {
    updateTotal();
    
    // Add input event listeners for form validation
    document.getElementById('customer_name').addEventListener('input', validateForm);
    document.getElementById('customer_phone').addEventListener('input', validateForm);
    
    // Add click event listener for payment button
    document.getElementById('paymentButton').addEventListener('click', function() {
        if (!this.disabled) {
            sendToMessenger();
        }
    });
});
</script>
{% endblock %}